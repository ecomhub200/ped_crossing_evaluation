<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDOT Pedestrian Crossing Accommodation Evaluation</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 4px solid #003d7a;
        }

        .header h1 {
            color: #003d7a;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header h2 {
            color: #666;
            font-size: 18px;
            font-weight: normal;
        }

        .header .doc-ref {
            color: #003d7a;
            font-size: 14px;
            margin-top: 10px;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #003d7a;
            color: white;
        }

        .btn-primary:hover {
            background: #002952;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #003d7a;
        }

        .section-title {
            color: #003d7a;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .badge {
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: normal;
        }

        .badge-step {
            background: #003d7a;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="number"] {
            width: 150px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 5px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .result-card {
            background: linear-gradient(135deg, #003d7a 0%, #0066cc 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin: 30px 0;
        }

        .result-display {
            font-size: 64px;
            font-weight: bold;
            margin: 20px 0;
        }

        .result-label {
            font-size: 18px;
            opacity: 0.9;
        }

        .tier-box {
            background: white;
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .tier-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .tier-value {
            font-size: 32px;
            font-weight: bold;
            color: #003d7a;
        }

        .recommendation-box {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 16px;
        }

        .recommendation-box h3 {
            font-size: 20px;
            margin-bottom: 12px;
        }

        .recommendation-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .recommendation-box li {
            margin-bottom: 6px;
        }

        .tier1 {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .tier2 {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }

        .tier3 {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }

        .tier4 {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .info-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .error-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        @media print {
            @page {
                margin: 0.75in;
                size: letter;
            }

            body {
                background: white;
                padding: 0;
            }

            .action-buttons,
            .no-print {
                display: none !important;
            }

            .container {
                box-shadow: none;
                max-width: 100%;
                padding: 0;
            }

            .header {
                background: #003d7a;
                color: white;
                padding: 30px;
                margin: -0.75in -0.75in 30px -0.75in;
                border-bottom: 4px solid #002952;
            }

            .header h1,
            .header h2,
            .header .doc-ref {
                color: white;
            }

            .section {
                page-break-inside: avoid;
                background: white;
                border: 1px solid #ddd;
                margin-bottom: 20px;
                padding: 15px;
            }

            .section-title {
                color: #003d7a;
                font-size: 16px;
                padding-bottom: 8px;
                border-bottom: 2px solid #003d7a;
            }

            .result-card {
                page-break-inside: avoid;
                page-break-before: always;
            }

            .recommendation-box {
                page-break-inside: avoid;
            }

            .container::after {
                content: "VDOT Traffic Engineering Division - IIM-TE-384.1 Pedestrian Crossing Accommodations";
                display: block;
                text-align: center;
                font-size: 10px;
                color: #666;
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #ddd;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VIRGINIA DEPARTMENT OF TRANSPORTATION</h1>
            <h2>Pedestrian Crossing Accommodations at Unsignalized Approaches</h2>
            <div class="doc-ref">IIM-TE-384.1 Evaluation Form</div>
        </div>

        <div class="action-buttons no-print">
            <button class="btn btn-success" onclick="saveData()">üíæ Save Progress</button>
            <button class="btn btn-secondary" onclick="saveAsHTML()">üíæ Save As HTML</button>
            <button class="btn btn-warning" onclick="clearForm()">üîÑ Clear Form</button>
            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Report</button>
        </div>

        <form id="evaluationForm">
            <!-- PROJECT INFORMATION -->
            <div class="section">
                <div class="section-title">PROJECT INFORMATION</div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Project Name/Location:</label>
                        <input type="text" id="projectLocation" onchange="saveAuto()">
                    </div>
                    <div class="form-group">
                        <label>Evaluation Date:</label>
                        <input type="date" id="evaluationDate" onchange="saveAuto()">
                    </div>
                </div>

                <div class="form-group">
                    <label>Candidate Crossing Location Description:</label>
                    <textarea id="locationDescription" onchange="saveAuto()"></textarea>
                </div>
            </div>

            <!-- STEP 1: SAFETY SCREENING -->
            <div class="section">
                <div class="section-title">
                    STEP 1: SAFETY SCREENING REQUIREMENTS
                    <span class="badge badge-step">MANDATORY</span>
                </div>

                <div class="info-box">
                    <strong>Note:</strong> ALL safety screening requirements must be met before proceeding to Step 2. If any requirement fails, a crosswalk shall NOT be installed at this location.
                </div>

                <!-- Spacing Requirement -->
                <div class="form-group">
                    <label>Distance to nearest marked crosswalk or signalized intersection (feet):</label>
                    <input type="number" id="crosswalkDistance" onchange="evaluateScreening()">
                    <div id="spacingStatus"></div>
                </div>

                <!-- Sight Distance -->
                <div class="form-group">
                    <label>Posted Speed Limit (mph):</label>
                    <input type="number" id="postedSpeed" onchange="evaluateScreening()">
                </div>

                <div class="form-group">
                    <label>Measured Stopping Sight Distance (feet):</label>
                    <input type="number" id="sightDistance" onchange="evaluateScreening()">
                    <div id="sightDistanceStatus"></div>
                </div>

                <!-- Tier Determination for Countermeasures -->
                <div class="form-group">
                    <label>Does location fall into Tier 3 or Tier 4?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="tierCheck" value="no" onchange="evaluateScreening()"> No (Tier 1 or 2)</label>
                        <label><input type="radio" name="tierCheck" value="yes_with" onchange="evaluateScreening()"> Yes, with countermeasures identified</label>
                        <label><input type="radio" name="tierCheck" value="yes_without" onchange="evaluateScreening()"> Yes, without countermeasures</label>
                    </div>
                    <div id="tierCheckStatus"></div>
                </div>

                <div id="step1Result"></div>
            </div>

            <!-- STEP 2: CROSSWALK INSTALLATION CRITERIA -->
            <div class="section" id="step2Section">
                <div class="section-title">
                    STEP 2: CROSSWALK INSTALLATION CRITERIA
                    <span class="badge badge-step">EVALUATION</span>
                </div>

                <div class="info-box">
                    <strong>Installation Decision:</strong><br>
                    ‚Ä¢ <strong>SHALL</strong> install if all 5 criteria met OR 20+ pedestrians/hour crossing<br>
                    ‚Ä¢ <strong>SHOULD</strong> install if 3 or more criteria met<br>
                    ‚Ä¢ <strong>MAY</strong> install if 1 or 2 criteria met
                </div>

                <!-- Criterion A -->
                <div class="form-group">
                    <label>
                        <strong>Criterion A:</strong> Location between two pedestrian-oriented land uses or destinations
                    </label>
                    <div class="radio-group">
                        <label><input type="radio" name="criteriaA" value="yes" onchange="evaluateCriteria()"> Yes</label>
                        <label><input type="radio" name="criteriaA" value="no" onchange="evaluateCriteria()"> No</label>
                    </div>
                </div>

                <!-- Criterion B -->
                <div class="form-group">
                    <label>
                        <strong>Criterion B:</strong> Connects to at least one pedestrian facility or access route
                    </label>
                    <div class="radio-group">
                        <label><input type="radio" name="criteriaB" value="yes" onchange="evaluateCriteria()"> Yes</label>
                        <label><input type="radio" name="criteriaB" value="no" onchange="evaluateCriteria()"> No</label>
                    </div>
                </div>

                <!-- Criterion C -->
                <div class="form-group">
                    <label>
                        <strong>Criterion C:</strong> Posted speed ‚â•30 mph OR >1,500 vehicles/day
                    </label>
                    <div class="radio-group">
                        <label><input type="radio" name="criteriaC" value="yes" onchange="evaluateCriteria()"> Yes</label>
                        <label><input type="radio" name="criteriaC" value="no" onchange="evaluateCriteria()"> No</label>
                    </div>
                </div>

                <!-- Criterion D -->
                <div class="form-group">
                    <label>
                        <strong>Criterion D:</strong> >600 ft (urban) or >1,000 ft (suburban/rural) to nearest crosswalk
                    </label>
                    <div class="radio-group">
                        <label><input type="radio" name="criteriaD" value="yes" onchange="evaluateCriteria()"> Yes</label>
                        <label><input type="radio" name="criteriaD" value="no" onchange="evaluateCriteria()"> No</label>
                    </div>
                </div>

                <!-- Criterion E -->
                <div class="form-group">
                    <label>
                        <strong>Criterion E:</strong> On PSAP priority corridor or within crash cluster
                    </label>
                    <div class="radio-group">
                        <label><input type="radio" name="criteriaE" value="yes" onchange="evaluateCriteria()"> Yes</label>
                        <label><input type="radio" name="criteriaE" value="no" onchange="evaluateCriteria()"> No</label>
                    </div>
                </div>

                <!-- Pedestrian Count -->
                <div class="form-group">
                    <label>Pedestrians per hour crossing (if counted):</label>
                    <input type="number" id="pedCount" placeholder="Optional" onchange="evaluateCriteria()">
                </div>

                <div id="step2Result"></div>
            </div>

            <!-- STEP 3: ROADWAY CHARACTERISTICS -->
            <div class="section" id="step3Section">
                <div class="section-title">
                    STEP 3: ROADWAY CHARACTERISTICS FOR TIER DETERMINATION
                    <span class="badge badge-step">COUNTERMEASURES</span>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Roadway Configuration:</label>
                        <select id="roadwayConfig" onchange="determineTier()">
                            <option value="">-- Select --</option>
                            <option value="single_oneway">Single lane, one-way</option>
                            <option value="2lane_undivided">2 Lanes (undivided two-way)</option>
                            <option value="3lane_turn">3 Lanes (center turn lane)</option>
                            <option value="4lane_undivided">4 Lanes (undivided two-way)</option>
                            <option value="5lane_turn">5 Lanes (center turn lane)</option>
                            <option value="6lane_undivided">6+ Lanes (undivided two-way)</option>
                            <option value="2lane_divided">2 Lanes with raised median</option>
                            <option value="2lane_oneway">2 Lanes One-Way</option>
                            <option value="4lane_divided">4 Lanes (two-way with median)</option>
                            <option value="3lane_oneway">3 Lanes One-Way</option>
                            <option value="6lane_divided">6+ Lanes (two-way with median)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Average Daily Traffic (ADT):</label>
                        <select id="trafficADT" onchange="determineTier()">
                            <option value="">-- Select --</option>
                            <option value="1500-9000">1,500 to 9,000 vpd</option>
                            <option value="9000-12000">9,000 to 12,000 vpd</option>
                            <option value="12000-15000">12,000 to 15,000 vpd</option>
                            <option value="15000+">More than 15,000 vpd</option>
                        </select>
                    </div>
                </div>

                <div id="step3Result"></div>
            </div>

            <!-- STEP 4: MARKING PATTERN -->
            <div class="section" id="step4Section">
                <div class="section-title">
                    STEP 4: CROSSWALK MARKING PATTERN
                    <span class="badge badge-step">DESIGN</span>
                </div>

                <div class="form-group">
                    <label>Is this a STOP-controlled approach?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="stopControlled" value="yes" onchange="determineMarking()"> Yes</label>
                        <label><input type="radio" name="stopControlled" value="no" onchange="determineMarking()"> No</label>
                    </div>
                </div>

                <div id="step4Result"></div>
            </div>

            <!-- EVALUATOR INFORMATION -->
            <div class="section">
                <div class="section-title">EVALUATOR INFORMATION</div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Evaluated by:</label>
                        <input type="text" id="evaluatorName" onchange="saveAuto()">
                    </div>
                    <div class="form-group">
                        <label>Title/Position:</label>
                        <input type="text" id="evaluatorTitle" onchange="saveAuto()">
                    </div>
                </div>

                <div class="form-group">
                    <label>Additional Notes:</label>
                    <textarea id="additionalNotes" onchange="saveAuto()"></textarea>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Auto-save functionality
        function saveAuto() {
            // Auto-save happens in background
        }

        // Step 1: Safety Screening Evaluation
        function evaluateScreening() {
            const distance = parseFloat(document.getElementById('crosswalkDistance').value) || 0;
            const speed = parseFloat(document.getElementById('postedSpeed').value) || 0;
            const sightDist = parseFloat(document.getElementById('sightDistance').value) || 0;
            const tierCheck = document.querySelector('input[name="tierCheck"]:checked');

            let allPass = true;
            let failReasons = [];

            // Spacing requirement
            const spacingStatus = document.getElementById('spacingStatus');
            if (distance > 0) {
                if (distance < 300) {
                    spacingStatus.innerHTML = '<div class="status-indicator status-fail">‚ùå FAIL - Must be at least 300 feet from nearest crosswalk</div>';
                    allPass = false;
                    failReasons.push('Spacing requirement not met (<300 feet)');
                } else {
                    spacingStatus.innerHTML = '<div class="status-indicator status-pass">‚úì PASS - Spacing requirement met</div>';
                }
            }

            // Sight distance requirement
            const ssdStatus = document.getElementById('sightDistanceStatus');
            if (speed > 0 && sightDist > 0) {
                const requiredSSD = getRequiredSSD(speed);
                if (sightDist < requiredSSD) {
                    ssdStatus.innerHTML = `<div class="status-indicator status-fail">‚ùå FAIL - Sight distance ${sightDist} ft is less than required ${requiredSSD} ft</div>`;
                    allPass = false;
                    failReasons.push(`Inadequate sight distance (${sightDist} ft < ${requiredSSD} ft required)`);
                } else {
                    ssdStatus.innerHTML = `<div class="status-indicator status-pass">‚úì PASS - Sight distance adequate (${sightDist} ft ‚â• ${requiredSSD} ft)</div>`;
                }
            }

            // Tier 3/4 countermeasure check
            const tierCheckStatus = document.getElementById('tierCheckStatus');
            if (tierCheck) {
                if (tierCheck.value === 'yes_without') {
                    tierCheckStatus.innerHTML = '<div class="status-indicator status-fail">‚ùå FAIL - Tier 3/4 location requires countermeasures to be identified before crosswalk installation</div>';
                    allPass = false;
                    failReasons.push('Tier 3/4 countermeasures not identified');
                } else if (tierCheck.value === 'yes_with') {
                    tierCheckStatus.innerHTML = '<div class="status-indicator status-pass">‚úì PASS - Tier 3/4 countermeasures identified</div>';
                } else {
                    tierCheckStatus.innerHTML = '<div class="status-indicator status-pass">‚úì PASS - Location is Tier 1 or 2</div>';
                }
            }

            // Overall Step 1 result
            const step1Result = document.getElementById('step1Result');
            if (distance > 0 && speed > 0 && sightDist > 0 && tierCheck) {
                if (allPass) {
                    step1Result.innerHTML = `
                        <div class="recommendation-box tier1">
                            <h3>‚úì STEP 1: PASS - All Safety Screening Requirements Met</h3>
                            <p>This location passes all mandatory safety screening requirements. Proceed to Step 2 to evaluate crosswalk installation criteria.</p>
                        </div>
                    `;
                    document.getElementById('step2Section').style.display = 'block';
                } else {
                    step1Result.innerHTML = `
                        <div class="recommendation-box tier4">
                            <h3>‚ùå STEP 1: FAIL - Safety Screening Requirements Not Met</h3>
                            <p><strong>Failure Reasons:</strong></p>
                            <ul>
                                ${failReasons.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                            <p><strong>Decision:</strong> A marked crosswalk SHALL NOT be installed at this location. No further evaluation is necessary.</p>
                        </div>
                    `;
                    document.getElementById('step2Section').style.display = 'none';
                }
            }
        }

        // Get required stopping sight distance based on speed
        function getRequiredSSD(speed) {
            const ssdTable = {
                25: 155, 30: 200, 35: 250, 40: 305, 45: 360, 50: 425, 55: 495
            };
            
            // Find closest speed or interpolate
            if (ssdTable[speed]) return ssdTable[speed];
            
            const speeds = Object.keys(ssdTable).map(Number).sort((a, b) => a - b);
            for (let i = 0; i < speeds.length - 1; i++) {
                if (speed > speeds[i] && speed < speeds[i + 1]) {
                    // Linear interpolation
                    const ratio = (speed - speeds[i]) / (speeds[i + 1] - speeds[i]);
                    return Math.round(ssdTable[speeds[i]] + ratio * (ssdTable[speeds[i + 1]] - ssdTable[speeds[i]]));
                }
            }
            
            return speed > 55 ? 999999 : 155; // >55 mph should not be marked
        }

        // Step 2: Evaluate Crosswalk Installation Criteria
        function evaluateCriteria() {
            const criteriaA = document.querySelector('input[name="criteriaA"]:checked');
            const criteriaB = document.querySelector('input[name="criteriaB"]:checked');
            const criteriaC = document.querySelector('input[name="criteriaC"]:checked');
            const criteriaD = document.querySelector('input[name="criteriaD"]:checked');
            const criteriaE = document.querySelector('input[name="criteriaE"]:checked');
            const pedCount = parseFloat(document.getElementById('pedCount').value) || 0;

            if (!criteriaA || !criteriaB || !criteriaC || !criteriaD || !criteriaE) {
                return; // Wait for all criteria to be answered
            }

            let metCount = 0;
            if (criteriaA.value === 'yes') metCount++;
            if (criteriaB.value === 'yes') metCount++;
            if (criteriaC.value === 'yes') metCount++;
            if (criteriaD.value === 'yes') metCount++;
            if (criteriaE.value === 'yes') metCount++;

            const step2Result = document.getElementById('step2Result');
            let recommendation = '';

            if (metCount === 5 || pedCount >= 20) {
                recommendation = `
                    <div class="recommendation-box tier1">
                        <h3>‚úì STEP 2: SHALL INSTALL CROSSWALK</h3>
                        <p><strong>Criteria Met:</strong> ${metCount} of 5${pedCount >= 20 ? ' (Plus 20+ pedestrians/hour)' : ''}</p>
                        <p><strong>Decision:</strong> A marked crosswalk SHALL be installed at this location.</p>
                        <p>Proceed to Step 3 to determine required countermeasures.</p>
                    </div>
                `;
                document.getElementById('step3Section').style.display = 'block';
            } else if (metCount >= 3) {
                recommendation = `
                    <div class="recommendation-box tier2">
                        <h3>‚úì STEP 2: SHOULD INSTALL CROSSWALK</h3>
                        <p><strong>Criteria Met:</strong> ${metCount} of 5</p>
                        <p><strong>Decision:</strong> A marked crosswalk SHOULD be installed at this location.</p>
                        <p>Proceed to Step 3 to determine required countermeasures.</p>
                    </div>
                `;
                document.getElementById('step3Section').style.display = 'block';
            } else if (metCount >= 1) {
                recommendation = `
                    <div class="recommendation-box tier3">
                        <h3>‚ö† STEP 2: MAY INSTALL CROSSWALK</h3>
                        <p><strong>Criteria Met:</strong> ${metCount} of 5</p>
                        <p><strong>Decision:</strong> A marked crosswalk MAY be installed at this location based on engineering judgment.</p>
                        <p>If proceeding with installation, continue to Step 3 to determine required countermeasures.</p>
                    </div>
                `;
                document.getElementById('step3Section').style.display = 'block';
            } else {
                recommendation = `
                    <div class="recommendation-box tier4">
                        <h3>‚ùå STEP 2: DO NOT INSTALL CROSSWALK</h3>
                        <p><strong>Criteria Met:</strong> 0 of 5</p>
                        <p><strong>Decision:</strong> A marked crosswalk should NOT be installed at this location. No crosswalk installation criteria are met.</p>
                    </div>
                `;
                document.getElementById('step3Section').style.display = 'none';
            }

            step2Result.innerHTML = recommendation;
        }

        // Step 3: Determine Tier and Countermeasures
        function determineTier() {
            const config = document.getElementById('roadwayConfig').value;
            const adt = document.getElementById('trafficADT').value;
            const speed = parseFloat(document.getElementById('postedSpeed').value) || 0;

            if (!config || !adt || speed === 0) {
                return; // Wait for all inputs
            }

            const tier = getTierAndCountermeasures(config, adt, speed);
            
            const step3Result = document.getElementById('step3Result');
            
            let tierClass = 'tier1';
            if (tier.tier === 2) tierClass = 'tier2';
            if (tier.tier === 3) tierClass = 'tier3';
            if (tier.tier === 4) tierClass = 'tier4';

            step3Result.innerHTML = `
                <div class="result-card">
                    <div class="result-label">TIER CLASSIFICATION</div>
                    <div class="result-display">TIER ${tier.tier}</div>
                    <div class="tier-box">
                        <div class="tier-title">Recommended Countermeasures</div>
                        <div style="text-align: left; margin-top: 10px;">
                            ${tier.countermeasures}
                        </div>
                    </div>
                </div>
                <div class="recommendation-box ${tierClass}">
                    <h3>STEP 3: COUNTERMEASURE REQUIREMENTS</h3>
                    ${tier.description}
                    ${tier.tier >= 3 ? '<p><strong>Note:</strong> An engineering study is required for Tier 3 and 4 locations to make final determination of countermeasures.</p>' : ''}
                </div>
            `;

            document.getElementById('step4Section').style.display = 'block';
        }

        // Tier determination logic based on VDOT tables
        function getTierAndCountermeasures(config, adt, speed) {
            // This is a simplified version - full implementation would need complete tier tables
            // Speed categories: ‚â§30, 35, ‚â•40
            let speedCat = '‚â§30';
            if (speed === 35) speedCat = '35';
            if (speed >= 40) speedCat = '‚â•40';

            // Determine tier based on configuration, ADT, and speed
            let tier = 1;
            let countermeasures = '';
            let description = '';

            // Basic tier logic (simplified)
            if (adt === '1500-9000') {
                if (config.includes('2lane_undivided')) {
                    tier = 1;
                    countermeasures = 'VE (Visibility Enhancements) or TC (Traffic Calming)';
                    description = '<p><strong>Required:</strong> High-visibility crosswalk with W11-2, S1-1, or W11-15 signage</p><p><strong>Recommended:</strong> Visibility Enhancements (VE)</p><p><strong>Optional:</strong> Traffic Calming Measures (TC)</p>';
                } else if (config.includes('4lane') || config.includes('5lane') || config.includes('6lane')) {
                    tier = 3;
                    countermeasures = 'RD (Roadway Reconfiguration) and/or RRFB (Rectangular Rapid Flashing Beacon)';
                    description = '<p><strong>Required:</strong> High-visibility crosswalk with W11-2, S1-1, or W11-15 signage AND one or more of the following:</p><ul><li>Roadway Reconfiguration (RD)</li><li>Pedestrian Hybrid Beacon (PHB)</li></ul>';
                }
            } else if (adt === '12000-15000' || adt === '15000+') {
                tier = 3;
                if (speed >= 40) tier = 4;
                countermeasures = 'PHB (Pedestrian Hybrid Beacon) and/or RD (Roadway Reconfiguration)';
                description = '<p><strong>Required:</strong> High-visibility crosswalk with W11-2, S1-1, or W11-15 signage AND inclusion of one or more of the following:</p><ul><li>Pedestrian Hybrid Beacon (PHB)</li><li>Roadway Reconfiguration (RD)</li></ul><p><strong>Optional:</strong> Review for Signal installation</p>';
            } else {
                tier = 2;
                countermeasures = 'RI (Refuge Island) and/or RRFB (Rectangular Rapid Flashing Beacon)';
                description = '<p><strong>Required:</strong> High-visibility crosswalk with W11-2, S1-1, or W11-15 signage</p><p><strong>Recommended:</strong> Refuge Island (RI) and/or Rectangular Rapid Flashing Beacon (RRFB)</p>';
            }

            return { tier, countermeasures, description };
        }

        // Step 4: Marking Pattern Determination
        function determineMarking() {
            const stopControlled = document.querySelector('input[name="stopControlled"]:checked');
            
            if (!stopControlled) return;

            const step4Result = document.getElementById('step4Result');

            if (stopControlled.value === 'yes') {
                step4Result.innerHTML = `
                    <div class="recommendation-box tier1">
                        <h3>STEP 4: STANDARD CROSSWALK MARKING</h3>
                        <p><strong>Recommended Pattern:</strong> Standard (Transverse Lines - Two Parallel Lines)</p>
                        <p>Standard crosswalks should be installed for STOP-controlled approaches, except where engineering judgment determines the need for high-visibility crosswalks.</p>
                        <p><strong>Specifications:</strong></p>
                        <ul>
                            <li>Two parallel white lines</li>
                            <li>Lines between 6" and 12" in width (typically 6")</li>
                            <li>Crosswalk width: Same as pedestrian facility or minimum 6 feet</li>
                        </ul>
                    </div>
                `;
            } else {
                step4Result.innerHTML = `
                    <div class="recommendation-box tier2">
                        <h3>STEP 4: HIGH-VISIBILITY CROSSWALK MARKING</h3>
                        <p><strong>Required Pattern:</strong> High-Visibility Crosswalk</p>
                        <p><strong>Recommended:</strong> Bar Pairs Pattern (8/8/8 design)</p>
                        <p><strong>Alternative:</strong> Longitudinal Lines (Continental)</p>
                        <p><strong>Specifications:</strong></p>
                        <ul>
                            <li>Bar Pairs: Pairs of 8" lines with 8" gap (8/8/8 pattern)</li>
                            <li>Spacing between pairs: 2' to 5' (avoid wheel paths)</li>
                            <li>Longitudinal Lines: 24" solid white lines spaced 2' to 5' apart</li>
                            <li>Crosswalk width: Same as pedestrian facility or minimum 6 feet</li>
                        </ul>
                        <p><strong>Advantages of Bar Pairs:</strong></p>
                        <ul>
                            <li>Comparable visibility to longitudinal lines</li>
                            <li>Less slippery for cyclists and pedestrians</li>
                            <li>Similar cost to longitudinal lines</li>
                        </ul>
                    </div>
                `;
            }
        }

        // Save data to localStorage
        function saveData() {
            const formData = {};
            
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    formData[input.id || input.name] = input.checked;
                } else if (input.type === 'radio') {
                    if (input.checked) {
                        formData[input.name] = input.value;
                    }
                } else {
                    formData[input.id] = input.value;
                }
            });
            
            localStorage.setItem('vdotCrosswalkEvaluation', JSON.stringify(formData));
            alert('‚úì Data saved successfully!');
        }

        // Save as HTML file
        function saveAsHTML() {
            const location = document.getElementById('projectLocation').value || 'Unnamed_Location';
            const date = document.getElementById('evaluationDate').value || new Date().toISOString().split('T')[0];
            
            const filename = `VDOT_Crosswalk_Evaluation_${location.replace(/[^a-z0-9]/gi, '_')}_${date}.html`;
            
            let htmlContent = document.documentElement.outerHTML;
            
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    if (input.checked) {
                        htmlContent = htmlContent.replace(
                            new RegExp(`<input([^>]*(?:id="${input.id}"|name="${input.name}")[^>]*)>`, 'g'),
                            `<input$1 checked>`
                        );
                    }
                } else if (input.type === 'radio') {
                    if (input.checked) {
                        htmlContent = htmlContent.replace(
                            new RegExp(`<input([^>]*name="${input.name}"[^>]*value="${input.value}"[^>]*)>`, 'g'),
                            `<input$1 checked>`
                        );
                    }
                } else if (input.tagName === 'TEXTAREA') {
                    htmlContent = htmlContent.replace(
                        new RegExp(`<textarea([^>]*id="${input.id}"[^>]*)>[\\s\\S]*?</textarea>`, 'g'),
                        `<textarea$1>${input.value}</textarea>`
                    );
                } else if (input.id) {
                    htmlContent = htmlContent.replace(
                        new RegExp(`<input([^>]*id="${input.id}"[^>]*value=")[^"]*"`, 'g'),
                        `<input$1${input.value}"`
                    );
                }
            });
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úì File saved as: ${filename}`);
        }

        // Clear form
        function clearForm() {
            if (confirm('Are you sure you want to clear all form data? This action cannot be undone.')) {
                document.getElementById('evaluationForm').reset();
                document.getElementById('step1Result').innerHTML = '';
                document.getElementById('step2Result').innerHTML = '';
                document.getElementById('step3Result').innerHTML = '';
                document.getElementById('step4Result').innerHTML = '';
                document.getElementById('step2Section').style.display = 'none';
                document.getElementById('step3Section').style.display = 'none';
                document.getElementById('step4Section').style.display = 'none';
                alert('‚úì Form cleared!');
            }
        }

        // Set today's date by default
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('evaluationDate').value = today;
            
            // Hide steps 2-4 initially
            document.getElementById('step2Section').style.display = 'none';
            document.getElementById('step3Section').style.display = 'none';
            document.getElementById('step4Section').style.display = 'none';
        });
    </script>
</body>
</html>